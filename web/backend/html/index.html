<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>test</title>
    <link rel="stylesheet" href="<?=BACKEND_PLUGIN_PATH?>layui/css/layui.css?v=<?=SYSTEM_VERSION?>" media="all">
    <link rel="stylesheet" href="<?=BACKEND_CSS_PATH?>global.css?v=<?=SYSTEM_VERSION?>" media="all">
    <link rel="stylesheet" href="<?=BACKEND_CSS_PATH?>index.css?v=<?=SYSTEM_VERSION?>" media="all">
    <script src="<?=BACKEND_PLUGIN_PATH?>layui/js/layui.js?v=<?=SYSTEM_VERSION?>"></script>
    <script src="<?=BACKEND_PLUGIN_PATH?>vue/vue.global.js?v=<?=SYSTEM_VERSION?>"></script>
</head>
<body>
<div class="container" id="container">
    <div class="layui-layout layui-layout-admin">
        <div class="layui-header header">
            <div class="layui-fluid">
                <a class="title">
                    {{systemTitle}}
                </a>
                <div class="layui-form layui-hide-xs component" lay-filter="LAY-site-header-component"></div>
                <div class="layui-hide-xs site-notice"></div>
                <ul class="layui-nav">
                    <li class="layui-nav-item">
                        <a href="">个人中心<span class="layui-badge-dot"></span></a>
                    </li>
                    <li class="layui-nav-item">
                        <a href=""><img src="//t.cn/RCzsdCq" class="layui-nav-img">jas</a>
                        <dl class="layui-nav-child">
                            <dd><a href="javascript:;">修改信息</a></dd>
                            <dd><a href="javascript:;">关于系统</a></dd>
                            <dd><a href="javascript:;">退出</a></dd>
                        </dl>
                    </li>
                </ul>
            </div>
        </div>
        <!--侧边栏-->
        <div class="layui-side layui-bg-black">
            <div class="layui-side-scroll">
                <ul class="layui-nav layui-nav-tree ">
                    <li class="layui-nav-item layui-nav-itemed">
                        <a href="javascript:;">默认展开</a>
                        <dl class="layui-nav-child">
                            <dd class="layui-this"><a href="javascript:;">选项1</a></dd>
                            <dd><a href="javascript:;">选项2</a></dd>
                            <dd><a href="">跳转</a></dd>
                        </dl>
                    </li>
                    <li class="layui-nav-item">
                        <a href="javascript:;">解决方案</a>
                        <dl class="layui-nav-child">
                            <dd><a href="">移动模块</a></dd>
                            <dd><a href="">后台模版</a></dd>
                            <dd><a href="">电商平台</a></dd>
                        </dl>
                    </li>
                </ul>
            </div>
        </div>
        <!--内容区域-->
        <div class="layui-body" id="content">

        </div>

    </div>
</div>
<script>
    const main = {
        data() {
            return {
                systemTitle:'Base System',
                websock: null, //建立的连接
                lockReconnect: false, //是否真正建立连接
                timeout: 20 * 1000, //20秒一次心跳
                timeoutObj: null, //心跳心跳倒计时
                serverTimeoutObj: null, //心跳倒计时
                timeoutnum: null //断开 重连倒计时
            }
        },
        created() {
            this.initWebSocket();
            console.log('组件钩子被调用')
        },
        destroyed() {
            //页面销毁时关闭长连接
            this.websocketclose();
        },
        methods: {
            initWebSocket() {
                //建立连接
                //初始化weosocket
                const wsuri = "ws://localhost:9998/echo";
                //建立连接
                this.websock = new WebSocket(wsuri);
                //连接成功
                this.websock.onopen = this.websocketonopen;
                //连接错误
                this.websock.onerror = this.websocketonerror;
                //接收信息
                this.websock.onmessage = this.websocketonmessage;
                //连接关闭
                this.websock.onclose = this.websocketclose;
            },
            reconnect() {
                //重新连接
                var that = this;
                if (that.lockReconnect) {
                    return;
                }
                that.lockReconnect = true;
                //没连接上会一直重连，设置延迟避免请求过多
                that.timeoutnum && clearTimeout(that.timeoutnum);
                that.timeoutnum = setTimeout(function() {
                    //新连接
                    that.initWebSocket();
                    that.lockReconnect = false;
                }, 5000);
            },
            reset() {
                //重置心跳
                var that = this;
                //清除时间
                clearTimeout(that.timeoutObj);
                clearTimeout(that.serverTimeoutObj);
                //重启心跳
                that.start();
            },
            start() {
                //开启心跳
                var self = this;
                self.timeoutObj && clearTimeout(self.timeoutObj);
                self.serverTimeoutObj && clearTimeout(self.serverTimeoutObj);
                self.timeoutObj = setTimeout(function() {
                    //这里发送一个心跳，后端收到后，返回一个心跳消息
                    if (self.websock.readyState == 1) {
                        //如果连接正常
                        self.websock.send("heartbeat");
                    } else {
                        //否则重连
                        self.reconnect();
                    }
                    self.serverTimeoutObj = setTimeout(function() {
                        //超时关闭
                        self.websock.close();
                    }, self.timeout);
                }, self.timeout);
            },
            websocketonopen() {
                //连接成功事件
                this.websocketsend('发送数据');
                //提示成功
                console.log("连接成功", 3);
                //开启心跳
                this.start();
            },
            websocketonerror(e) {
                //连接失败事件
                //错误
                console.log("WebSocket连接发生错误");
                //重连
                this.reconnect();
            },
            websocketclose(e) {
                //连接关闭事件
                //提示关闭
                console.log("连接已关闭");
                //重连
                this.reconnect();
            },
            websocketonmessage(event) {
                //接收服务器推送的信息
                //打印收到服务器的内容
                console.log("收到服务器信息",event.data);
                let data=event.data
                //收到服务器信息，心跳重置
                this.reset();
            },
            websocketsend(msg) {
                //向服务器发送信息
                this.websock.send(msg);
            }
    }
    };
    const app = Vue.createApp(main).mount('#container')
</script>
</body>
</html>
